---
title: "APIs"
author: "Arturo Bernal"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
  theme: united
  toc_depth: 3
  highlight: tango
editor_options: 
  chunk_output_type: inline
---



# API´s (Application Programming Interface)


## quantmod

Getting the HANG SENG Index from yahoo finance.

HANG SENG (^HSI) 
getSymbols("Symbol")
	
```{r include=FALSE}
library(quantmod)
```

Getting the data from a specific date:
getSymbols("symbol", from="YY/m/d",to="YY/m/d")

```{r}
getSymbols("^HSI",from="2020/01/01",to="2021/01/01")
```

There is no need to give a name to the object like HSI<-getSymbols("ticker"), automatically R stores the ticker information in the environment. 

The class of objects that getSymbols download is xts, which has the advantage that the index is the date. 

```{r}
class(HSI)
```

## Nasdaq Data Link (before Quandl)

You need to create an account (I suggest for you a free academic account) at https://data.nasdaq.com/


This APi has data related with equity, currencies, interest rates, options, economy, among others topics. 

Downloading the US Treasury Yield Curve Rates:
```{r}
library(Quandl)

ty_df<-Quandl("USTREASURY/YIELD", api_key="e7Z7FD5siZ8mDi_yTVLD")
```

The default class of objects are Data Frames, but we can also get it as"xts". 

```{r}
ty_xts<-Quandl("USTREASURY/YIELD", api_key="e7Z7FD5siZ8mDi_yTVLD",type="xts")

```


## In-house Api

Harvesting the web with rvest (to get tickers)

```{r include=FALSE}
library(quantmod)
library(xml2)
library(rvest)
```
This code is to read characters from web pages. In this case, to get the tickers from yahoo finance.

```{r}
# the page of of the criptocurrencies
yf <- "https://finance.yahoo.com/cryptocurrencies?offset=0&count=132"

#yf <- "https://finance.yahoo.com/quote/%5Emxx/components/"

html <- read_html(yf)

# To get the node a, wich contains characters 
node <- html_nodes(html,"a")

# To read the text in the node
node<-html_text(node, trim=TRUE)

# To get the elements that have USD (the tickers). For the IPC tickers, replace "USD" with ".MX". For other tickers, print the node object and look for patterns or select by rows.
tickers<-grep(pattern = "USD", x = node, value = TRUE)

# to get only the first 5 tickers

tickers1<-tickers[1:3]
tickers1
```
```{r}
#Select de dplyr
#BTC-USD["renglones","columas"]
#close<-`BTC-USD`[,4]
close
```

```{r include=FALSE}
getSymbols(tickers1)

```

When download, to select an element, we use the name of the object when we view it; in the bitcoin case would be `BTC-USD
```{r}

```


## Banxico API

```{r}
library("siebanxicor")
library(openxlsx)
```

First, we need to get the token from:

https://www.banxico.org.mx/SieAPIRest/service/v1/token

I suggest copying and paste the token into an object. To upload the token, we use the function setToken(token).
```{r}
token <- "aced5718479726cda81ebef95a4297268d6585fb79f616bc1f48aaae3357b138"
setToken(token)
```

We use the the function getSeriesData to download the data.  I also suggest storing the series number in an object. For example, the exchange rate peso dollar and the 3-year Mexican government bonds, the series number are: ("SF60653","SF43883")

```{r}

idSeries <- c("SF60653","SF43883")
```

Finally, we apply the function getSeriesData(idSeries, 'YY-m-d','YY-m-d') 

In R, usually YY=4 digit year, yy= 2 digit year, m= 2 digit month and d= 2 digit day.
```{r}
series <- getSeriesData(idSeries, '2015-01-15','2021-01-20')
```

The class of the objects is list. See in the Appendix to see the list structure. 
```{r}
class(series )
```

We transform it into a data frame. data.frame(list element)
```{r}
df<-data.frame(series[["SF60653"]])
df2<-data.frame(series[["SF43883"]])

```

Additionally, to merge the series, we use the merge function.

```{r}
me<-merge(df,df2,by.x="date",by.y="date",all=T)
```



# For loops to read and consolidate big data

If we want to get the close prices of all tickers, for example, 100. For each ticker, we must do:
```{r}
bit<-get("BTC-USD")[,4]
```

Loops are R's method for repeating a task, making them a useful tool for programming.

## for loops
In this session, we cover the "For loop". Other Loops are "While Loops".

There are two essential properties of the "for loops". First, results are not printed inside a loop unless you explicitly call it. 


A for loop repeats a task many times, once for each element in an input set. "for loops" provide a way to tell R, "Do this for every value of that." In R syntax, this looks like:

for (i in y:z) {

content(i)
}

The variable "i" is called index and could be replaced with other variables. The variables y and z must be numeric. The content must have an instruction for the index "i".


Suppose we want to print each element of the vector,  a<- c(4,5,6), like this:
```{r}
a<- seq(1,20)
print(a[1])
print(a[2])
print(a[3])

#...

print(a[20])

```

That is a tedious way. A for loop could help to do it faster when you have many more elements.

```{r}
a<- seq(1,20)
n<-length(a)
cont<-1

for (i in 10:20) {
print(a[i])
} 
  
```

If you see, you only printed the output, but most of the time, we want to store it in a vector, matrix or data frame. 

Modify the last "for loop" to store the results in a vector instead of printing it. Lets create another loop that store the sequence seq(1,20), multiplied by 2.  

```{r}
b<- seq(1,20)
n<-length(b)

# Is the object where the data will be stored (must be outside the loop), then we add another element with cbind

v1<-b[1]*2
#loop
for (i in 2:n){

v2<-b[i]*2

v1<-cbind(v1,v2) # merge
}
v1
```



## Consolidate big data using APIs

Suppose you want to store the close prices, from yahoo finance, of the tickers we has in the object "tickers".

Create a for loop to store the close price of each ticker in a xts object.

The function get, gets an object from the environment (name in the environment and "object").
```{r}
n<-length(tickers1)
close<-get("BTC-USD")
close<-close[,4]

# loop
for (i in 2:n) {
close2<-get(tickers1[i])[,4]
close<-cbind(close,close2)
}
close

```

# Appendix


## List and list to Data Frame
Lists are the R objects which contain elements of different types like − numbers, strings, vectors and another list inside it.


```{r}
my_list <- list(value1="a",value2 = c("b","c"))
my_list
```


```{r}
my_Serie <- list(Reference=list(date=c("date1","date2"),value = c(1,2)))
                                    mydf<-data.frame(my_Serie[["Reference"]])
mydf
```


## Xts objects
Code to transform and merge the Banxico data series in xts, for the exchange rate object, df and the interest rate object, df2.
```{r}
#datedata<-df[,1]

#datedata<-as.Date(datedata,format="%y-%m-%d")
#data<-xts(df,order.by = as.Date(datedata),as.POSIXct("%y-%m-%d"))

#datedata2<-df2[,1]
#datedata2<-as.Date(datedata2,format="%y-%m-%d")
#data2<-xts(df2,order.by = as.Date(datedata2),as.POSIXct("%y-%m-%d"))

#data3<-cbind(data,data2)
```

## Sources for harvesting the web with rvest 


html_nodes: Select nodes from an HTML document 

https://rdrr.io/cran/rvest/man/html_nodes.html

SelectorGadget

https://cran.r-project.org/web/packages/rvest/vignettes/selectorgadget.html

Harvesting the web with rvest
https://cran.r-project.org/web/packages/rvest/vignettes/harvesting-the-web.html

https://www.w3schools.com/cssref/sel_class.asp
